<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kapitola 18 â€“ VÄ›Å¡tÄ›nÃ­ z run (vÃ½bÄ›r 1â€“3/4)</title>
  <link rel="stylesheet" href="css/style.css">
  <script defer src="js/helpers.js"></script>
  <style>
    .qbox { margin: 0 0 12px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; }
    .qbox label { display:block; font-size: .95rem; margin-bottom: 6px; }
    .qbox .btn { margin-right: 6px; margin-bottom: 6px; }
    .btn.small { font-size: .9rem; padding: .35rem .6rem; }
    .rune-card.selected { outline: 2px solid var(--accent, #7aa2f7); }
    .rune-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
    .rune-card { display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .rune-card img { width:64px; height:64px; display:block; margin:6px auto; }
    .caption { display:block; margin: 2px 0 6px 0; opacity:.9; }
  </style>
</head>
<body>
<div class="container">
  <div class="nav"><a class="btn" href="kap17a.html">â† ZpÄ›t</a><a class="btn" href="index.html">ğŸ  DomÅ¯</a></div>
  <h1>Kapitola 18 â€“ VÄ›Å¡tÄ›nÃ­ z run (Minulost â€¢ PÅ™Ã­tomnost â€¢ Budoucnost)</h1>

  <div class="panel">

    <div class="dialogue">
      <img src="img/alchymista_mavajici.png" alt="Alchymista" class="avatar">
      <div class="bubble">
        <p><strong>Alchymista:</strong> <span id="prompt">â€Vyber 1. runu â€“ <em>MINULOST</em>. AÅ¥ jsou tÅ™i rÅ¯znÃ© â€“ osud rÃ¡d mluvÃ­ tÅ™emi hlasy.â€œ</span></p>
      </div>
    </div>

    <div class="bubble qbox" id="qbox">
      <label class="small">Nejprve poloÅ¾ otÃ¡zku osudu:</label>
      <div>
        <button class="btn small" data-q="today">Co dnes potÅ™ebuji vÄ›dÄ›t?</button>
        <button class="btn small" data-q="fight">Jak dopadne boj?</button>
        <button class="btn small" data-q="future">Co pÅ™inese budoucnost?</button>
      </div>
      <p class="small" id="qchosen" style="margin-top:6px;opacity:.85;"></p>
    </div>

    <div class="bubble" id="selector">
      <label class="small" id="labelRole">Vyber 1. runu (MINULOST):</label>
      <div id="grid" class="rune-grid"></div>
      <p id="hint" class="feedback"></p>
      <hr>
      <p class="small"><strong>VybranÃ© runy:</strong> <span id="summary">â€” â€¢ â€” â€¢ â€”</span></p>
    </div>
  </div>
</div>

<script>
const ROLES = ['MINULOST','PÅ˜ÃTOMNOST','BUDOUCNOST'];
let step = 1; // 1..3
let runes = [];
let sel = { 1: null, 2: null, 3: null };

function loadFromStorage(){
  sel[1] = localStorage.getItem('r1');
  sel[2] = localStorage.getItem('r2');
  sel[3] = localStorage.getItem('r3');
  if(!sel[1]) step = 1;
  else if(!sel[2]) step = 2;
  else step = 3;
}
function saveToStorage(){
  if(sel[1]) localStorage.setItem('r1', sel[1]);
  if(sel[2]) localStorage.setItem('r2', sel[2]);
  if(sel[3]) localStorage.setItem('r3', sel[3]);
}
function updateSummary(){
  const s1 = sel[1] || 'â€”';
  const s2 = sel[2] || 'â€”';
  const s3 = sel[3] || 'â€”';
  document.getElementById('summary').textContent = s1 + ' â€¢ ' + s2 + ' â€¢ ' + s3;
}
function setPrompts(){
  document.getElementById('labelRole').textContent = `Vyber ${step}. runu (${ROLES[step-1]}):`;
  document.getElementById('prompt').innerHTML = `â€Vyber ${step}. runu â€“ <em>${ROLES[step-1]}</em>. AÅ¥ jsou tÅ™i rÅ¯znÃ© â€“ osud rÃ¡d mluvÃ­ tÅ™emi hlasy.â€œ`;
}
function disabledSet(){
  const s = new Set();
  if(sel[1]) s.add(sel[1].toLowerCase());
  if(sel[2]) s.add(sel[2].toLowerCase());
  return s;
}
function renderGrid(){
  const g = document.getElementById('grid');
  const dis = disabledSet();
  g.innerHTML = runes.map(r=>{
    const isDisabled = dis.has((r.name||'').toLowerCase());
    const isSelected = (sel[step] && sel[step].toLowerCase() === (r.name||'').toLowerCase());
    const classes = 'btn rune-card' + (isSelected ? ' selected' : '');
    const attrDis = isDisabled ? 'disabled' : '';
    return `<button class='${classes}' ${attrDis} onclick='pickRune("${r.name}")'>
      <img src='runes/${r.id}.png' alt='${r.name}'>
      <span class='caption'>${r.name}</span>
    </button>`;
  }).join('');
}
function pickRune(name){
  sel[step] = name;
  saveToStorage();
  updateSummary();
  if(step < 3){
    step++;
    setPrompts();
    renderGrid();
    document.getElementById('hint').textContent = '';
  }else{
    window.location.href = 'kap18vestba.html';
  }
}

function onQuestionClick(ev){
  const btn = ev.target.closest('button[data-q]');
  if(!btn) return;
  const q = btn.getAttribute('data-q');
  localStorage.setItem('q', q);
  const map = {
    today: 'â€Co dnes potÅ™ebuji vÄ›dÄ›t?â€œ',
    fight: 'â€Jak dopadne boj?â€œ',
    future: 'â€Co pÅ™inese budoucnost?â€œ'
  };
  document.getElementById('qchosen').textContent = 'OtÃ¡zka nastavena: ' + (map[q]||'â€”');
}

async function init(){
  loadFromStorage();
  try{
    runes = await fetch('data/runes.json', {cache:'no-store'}).then(r=>r.json());
  }catch(e){
    document.getElementById('hint').textContent = 'NepodaÅ™ilo se naÄÃ­st seznam run.';
    return;
  }
  setPrompts();
  updateSummary();
  renderGrid();
  document.getElementById('qbox').addEventListener('click', onQuestionClick);
  const q = localStorage.getItem('q');
  if(q){
    const map = { today: 'â€Co dnes potÅ™ebuji vÄ›dÄ›t?â€œ', fight: 'â€Jak dopadne boj?â€œ', future: 'â€Co pÅ™inese budoucnost?â€œ' };
    document.getElementById('qchosen').textContent = 'OtÃ¡zka nastavena: ' + (map[q]||'â€”');
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
