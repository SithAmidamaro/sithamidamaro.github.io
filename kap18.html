<!DOCTYPE html>
<html lang="cs"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kapitola 18 – Věštění z run (výběr 1–3/4)</title>
<link rel="stylesheet" href="css/style.css">
<script defer src="js/helpers.js"></script>
<script defer src="js/runes.js"></script>
<style>
  .q-grid{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0; }
  .q-btn{ cursor:pointer; }
  .q-btn.selected {
    outline: 2.5px solid #7c3aed;
    background: linear-gradient(90deg, #e9d8fd 0%, #c4b5fd 100%);
    color: #3b0764;
    box-shadow: 0 0 0 3px rgba(124,58,237,.18) inset;
  }
  .rune-card.selected {
    outline: 2.5px solid #7c3aed !important;
    background: linear-gradient(90deg, #e9d8fd 0%, #c4b5fd 100%) !important;
    color: #3b0764 !important;
    box-shadow: 0 0 0 3px rgba(124,58,237,.18) inset !important;
  }
</style>
</head><body>
<div class="container">
  <div class="nav"><a class="btn" href="kap17a.html">← Zpět</a></div>
  <h1>Kapitola 18 – Věštění z run (výběr 1–3/4)</h1>
  <div class="panel">
    <div class="dialogue">
      <img src="img/alchemista_smejici_orb.png" alt="Alchymista" class="avatar">
      <div class="bubble">
        <p><strong>Alchymista:</strong> <span id="prompt">„Vyber 1. runu – <em></em>. Ať jsou tři různé – osud rád mluví třemi hlasy.“</span></p>
      </div>
    </div>

    <div class="bubble">
      <label class="small"><strong>Nejprve otázka:</strong></label>
      <div id="qgrid" class="q-grid"></div>
      <p class="small" id="qhint"></p>
    </div>

    <div class="bubble" id="selector">
      <label class="small" id="labelRole">Vyber 1. runu (ZAČÁTEK):</label>
      <div id="grid" class="rune-grid"></div>
      <p id="hint" class="feedback"></p>
      <hr>
      <p class="small"><strong>Vybrané runy:</strong> <span id="summary">— • — • —</span></p>
    </div>
  </div>
</div>
<script>
// Avatar efekt: změna obrázku na mávajícího alchymistu na 1 sekundu
document.addEventListener('DOMContentLoaded', function() {
  var avatar = document.querySelector('.avatar');
  if(avatar) {
    var origSrc = avatar.getAttribute('src');
    avatar.addEventListener('click', function() {
      avatar.src = 'img/alchymista_mavajici.png';
      setTimeout(function() {
        avatar.src = origSrc;
      }, 1000);
    });
  }
});
const ROLES = ['ZAČÁTEK','PŘEKÁŽKA','VÝSLEDEK'];
const QUESTIONS = [
  { id:'default', label:'Bez konkrétní otázky' },
  { id:'today',   label:'Co dnes potřebuji vědět?' },
  { id:'fight',   label:'Jak dopadne boj?' },
  { id:'future',  label:'Co přinese budoucnost?' }
];
let step = 1; // 1..3
let runes = [];
let sel = { 1: null, 2: null, 3: null };
let qsel = 'default';

function loadFromStorage(){
  sel[1] = localStorage.getItem('r1');
  sel[2] = localStorage.getItem('r2');
  sel[3] = localStorage.getItem('r3');
  qsel   = localStorage.getItem('rq') || 'default';
  if(!sel[1]) step=1; else if(!sel[2]) step=2; else if(!sel[3]) step=3; else step=3;
}
function saveToStorage(){
  if(sel[1]) localStorage.setItem('r1', sel[1]);
  if(sel[2]) localStorage.setItem('r2', sel[2]);
  if(sel[3]) localStorage.setItem('r3', sel[3]);
  if(qsel)   localStorage.setItem('rq', qsel);
}
function updateSummary(){
  const s1 = sel[1] || '—';
  const s2 = sel[2] || '—';
  const s3 = sel[3] || '—';
  document.getElementById('summary').textContent = s1 + ' • ' + s2 + ' • ' + s3;
}
function setPrompts(){
  document.getElementById('labelRole').textContent = `Vyber ${step}. runu (${ROLES[step-1]}):`;
  document.getElementById('prompt').innerHTML = `„Vyber ${step}. runu – <em>${ROLES[step-1]}</em>. Ať jsou tři různé – osud rád mluví třemi hlasy.“`;
}
function disabledSet(){
  const s = new Set();
  if(sel[1]) s.add(sel[1].toLowerCase());
  if(sel[2]) s.add(sel[2].toLowerCase());
  if(step===1){ s.delete(sel[1]?.toLowerCase()); }
  if(step===2){ s.delete(sel[2]?.toLowerCase()); }
  if(step===3){ s.delete(sel[3]?.toLowerCase()); }
  return s;
}
function renderGrid(){
  const g = document.getElementById('grid');
  const dis = disabledSet();
  g.innerHTML = runes.map(r=>{
    const isDisabled = dis.has((r.name||'').toLowerCase());
    const isSelected = (
      (sel[1] && sel[1].toLowerCase() === (r.name||'').toLowerCase()) ||
      (sel[2] && sel[2].toLowerCase() === (r.name||'').toLowerCase()) ||
      (sel[3] && sel[3].toLowerCase() === (r.name||'').toLowerCase())
    );
    const classes = 'btn rune-card' + (isSelected ? ' selected' : '');
    const attrDis = isDisabled ? 'disabled' : '';
    return `<button class='${classes}' ${attrDis} onclick='pickRune("${r.name}")'>
      <img src='runes/${r.id}.png' alt='${r.name}'>
      <span class='caption'>${r.name}</span>
    </button>`;
  }).join('');
}
function renderQuestions(){
  const g = document.getElementById('qgrid');
  g.innerHTML = QUESTIONS.map(q=>{
    const classes = 'btn q-btn' + (qsel === q.id ? ' selected' : '');
    return `<button class='${classes}' onclick='setQuestion("${q.id}")'>${q.label}</button>`;
  }).join('');
  document.getElementById('qhint').textContent = QUESTIONS.find(q=>q.id===qsel)?.label || '';
}
function setQuestion(id){
  qsel = id;
  saveToStorage();
  renderQuestions();
}
function pickRune(name){
  sel[step] = name;
  saveToStorage();
  updateSummary();
    const btns = document.querySelectorAll('.rune-card');
    btns.forEach(b=>{
      if(b.querySelector('.caption').textContent===name) b.classList.add('selected');
      else b.classList.remove('selected');
    });
  if(step < 3){
    step++;
    setPrompts();
    renderGrid();
    document.getElementById('hint').textContent = '';
  }else{
    window.location.href = 'kap18vestba.html';
  }
}
async function init(){
  loadFromStorage();
  renderQuestions();
  try{
    runes = await fetch('data/runes.json', {cache:'no-store'}).then(r=>r.json());
  }catch(e){
    document.getElementById('hint').textContent = 'Nepodařilo se načíst seznam run.';
    return;
  }
  setPrompts();
  updateSummary();
  renderGrid();
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body></html>
